<!DOCTYPE html>

<html lang="it" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>user_routes &#8212; Documentazione prokect_work_mp 1.0 </title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=945aedf1"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=45930005"></script>
    <link rel="index" title="Indice" href="../genindex.html" />
    <link rel="search" title="Cerca" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Codice sorgente per user_routes</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">db</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_connection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utility.authentication</span><span class="w"> </span><span class="kn">import</span> <span class="n">authenticate</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utility.utility</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_headers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utility.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_session</span><span class="p">,</span> <span class="n">delete_session</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bcrypt</span>

<div class="viewcode-block" id="handle_login">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_login">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_login</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    POST /login</span>
<span class="sd">    JSON: {&quot;username&quot;:&quot;...&quot;,&quot;password&quot;:&quot;...&quot;}</span>
<span class="sd">    Verifica l&#39;utente e crea una sessione</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ricevuta richiesta di login&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tentativo di login per l&#39;utente: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Errore nel parsing della richiesta di login&quot;</span><span class="p">)</span>
        <span class="n">error_bytes</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON non valido o campi mancanti&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_bytes</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_bytes</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># ricerca dell&#39;utente nel database</span>
    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT id, username, password, email, role</span>
<span class="s2">            FROM users</span>
<span class="s2">            WHERE username = ?</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Utente non trovato: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Utente inesistente&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">user_id</span><span class="p">,</span> <span class="n">db_username</span><span class="p">,</span> <span class="n">db_hashed_pw</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">role</span> <span class="o">=</span> <span class="n">row</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Utente trovato: </span><span class="si">{</span><span class="n">db_username</span><span class="si">}</span><span class="s2">, Ruolo: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># controllo per password, bcrypt.checkpw ritorna True se la password è corretta</span>
    <span class="k">if</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">db_hashed_pw</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Password corretta per l&#39;utente: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># password corretta, crea sessione nel database e la gestisce nel be</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sessione creata: </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">user_obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">db_username</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Login effettuato con successo&quot;</span>
        <span class="p">}</span>
        <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">user_obj</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        
        <span class="c1"># header extra per Set-Cookie per passare il session_id al fe una volta</span>
        <span class="c1"># loggato nei cookie l&#39;fe lo salva ed è possibile fare richieste successive </span>
        <span class="c1"># al server e il resto delle richieste saranno autenticate</span>
        
        <span class="n">extra_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Set-Cookie&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;session_id=</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">; HttpOnly; Path=/&quot;</span>
        <span class="p">}</span>
        
        <span class="c1">#tramite metodo set headers impostiamo header extra necessari per passare il session_id al fe</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response_data</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="n">extra_headers</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Password errata per l&#39;utente: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Username o password errati&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_logout">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_logout">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_logout</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;POST /logout - Elimina la sessione dell&#39;utente.&quot;&quot;&quot;</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cookie&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cookies</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Nessuna sessione attiva&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;session_id=&quot;</span> <span class="ow">in</span> <span class="n">cookie</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;session_id=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_id</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Nessuna sessione attiva&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">delete_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>

    <span class="c1"># imposta il cookie di sessione come scaduto (normalmente si utilizza con la funzione logout)</span>
    <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Logout effettuato con successo&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">extra_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Set-Cookie&quot;</span><span class="p">:</span> <span class="s2">&quot;session_id=; HttpOnly; Path=/; Max-Age=0&quot;</span>
    <span class="p">}</span>
    <span class="n">set_headers</span><span class="p">(</span>
        <span class="n">handler</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">response_data</span><span class="o">=</span><span class="n">response_data</span><span class="p">,</span>
        <span class="n">extra_headers</span><span class="o">=</span><span class="n">extra_headers</span>
    <span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_get_all_users">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_get_all_users">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_get_all_users</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span><span class="n">authenticated_user</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GET /users - Ritorna tutti gli utenti senza le password.&quot;&quot;&quot;</span>
    <span class="c1"># tramite autorizzazione, permette solo agli utenti con ruolo admin</span>
    <span class="c1"># di vedere tutti gli utenti</span>
    <span class="k">if</span> <span class="n">authenticated_user</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;admin&quot;</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Autorizzazione richiesta&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, username, email, role FROM users&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
        <span class="p">})</span>

    <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response_data</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_get_user_by_id">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_get_user_by_id">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_get_user_by_id</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GET /users/&lt;id&gt; - Ritorna il singolo utente se esiste.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;ID non valido&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, username, password, email FROM users WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response_data</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User non trovato&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>   </div>


<div class="viewcode-block" id="handle_get_current_user">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_get_current_user">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_get_current_user</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GET /current-user</span>
<span class="sd">    Ritorna i dettagli dell&#39;utente autenticato in base al cookie session_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cookie&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;session_id=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_id</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Sessione non trovata&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sessione non valida&quot;</span><span class="p">)</span>
        
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT u.id, u.username, u.email, u.role</span>
<span class="s2">            FROM sessions s</span>
<span class="s2">            JOIN users u ON s.user_id = u.id</span>
<span class="s2">            WHERE s.session_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session_id</span><span class="p">,))</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">],</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response_data</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Sessione non valida&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sessione non valida&quot;</span><span class="p">)</span>
        
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>      </div>


<div class="viewcode-block" id="is_valid_password">
<a class="viewcode-back" href="../user_routes.html#user_routes.is_valid_password">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_valid_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica se la password inserita per la registrazione utente e&#39;valida.</span>
<span class="sd">    I constrolli per la password sono i seguenti:</span>
<span class="sd">    - Verifica lunghezza 8 caratteri</span>
<span class="sd">    - Verifica presenza di una lettera maiuscola</span>
<span class="sd">    - Verifica presenza di una lettera minuscola</span>
<span class="sd">    - Verifica presenza di un numero</span>
<span class="sd">    - Verifica presenza di un carattere speciale</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="c1"># Caratteri speciali da accettare nella password</span>
    <span class="n">special_characters</span> <span class="o">=</span> <span class="s2">&quot;!@#$%^&amp;*()_+-=[]</span><span class="si">{}</span><span class="se">\\</span><span class="s2">|;:&#39;</span><span class="se">\&quot;</span><span class="s2">,.&lt;&gt;?/`~&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span> <span class="ow">in</span> <span class="n">special_characters</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="handle_create_user">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_create_user">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_create_user</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;POST /users - Crea un nuovo utente nel DB.&quot;&quot;&quot;</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON non valido&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># dati utente</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># password dell&#39;utente prima del hashing</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="c1"># validazione campi</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Tutti i campi sono obbligatori&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># validazione formato della email</span>
    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span> <span class="ow">or</span> <span class="n">email</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">email</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Email non valida&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># validazione password</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_password</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Password non valida la password deve avere la seguente froma:  almeno 8 caratteri, &quot;</span>
                <span class="s2">&quot;almeno una lettera minuscola, almeno una lettera maiuscola, un numero e un carattere speciale.&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># hashing della  password tramite l&#39;utililizzo di bcrypt</span>
    <span class="n">hashed_pw</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO users (username, password, email)</span>
<span class="s2">                VALUES (?, ?, ?)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hashed_pw</span><span class="p">,</span> <span class="n">email</span><span class="p">))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># error per gestire violazioni UNIQUE su username o email</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Violazione di unicità: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
            <span class="k">return</span>
    
    <span class="n">new_user</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">new_id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">email</span>
    <span class="p">}</span>
    <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="n">response_data</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_update_user">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_update_user">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_update_user</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PUT /users/&lt;id&gt; - Aggiorna i campi di un utente (username, password, email).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;ID non valido&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON non valido&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># campi aggiornabili dell&#39;user</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># nuova password da aggiornare prima che venga hashata</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># check per vedere se l&#39;utente esiste nel db</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, username, password, email FROM users WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Utente non trovato&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">existing_id</span><span class="p">,</span> <span class="n">existing_username</span><span class="p">,</span> <span class="n">existing_hashed_pw</span><span class="p">,</span> <span class="n">existing_email</span> <span class="o">=</span> <span class="n">row</span>

        <span class="c1"># se i campi non sono presenti manteniamo i valori esistendi</span>
        <span class="n">updated_username</span> <span class="o">=</span> <span class="n">username</span> <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">existing_username</span>
        <span class="n">updated_email</span> <span class="o">=</span> <span class="n">email</span> <span class="k">if</span> <span class="n">email</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">existing_email</span>

        <span class="c1"># processo per la password qualora presente. viene hashata con bcrypt</span>
        <span class="c1"># se non presente si mantiene la password esistente</span>
        <span class="k">if</span> <span class="n">new_password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hashed_pw</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">new_password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hashed_pw</span> <span class="o">=</span> <span class="n">existing_hashed_pw</span>

        <span class="c1"># andiamo ad aggiornare il DB</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                UPDATE users</span>
<span class="s2">                SET username = ?, password = ?, email = ?</span>
<span class="s2">                WHERE id = ?</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">updated_username</span><span class="p">,</span> <span class="n">hashed_pw</span><span class="p">,</span> <span class="n">updated_email</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># gestiamo errori per violazioni di tipo UNIQUE su username o email</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Violazione di unicità: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="n">updated_user</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">updated_username</span><span class="p">,</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">updated_email</span><span class="p">,</span>
        <span class="c1"># rimosso la password per motivi di sicurezza anche se hashata</span>
        <span class="c1"># &quot;password&quot;: hashed_pw </span>
    <span class="p">}</span>
    <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">updated_user</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response_data</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_delete_user">
<a class="viewcode-back" href="../user_routes.html#user_routes.handle_delete_user">[documenti]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_delete_user</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DELETE /users/&lt;id&gt; - Elimina l&#39;utente dal DB.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid ID&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="c1"># check per vedere se l&#39;utente esiste</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM users WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;User not found&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="n">error_response</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_response</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM users WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user_id</span><span class="p">,))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">response_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2"> deleted&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">set_headers</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">response_data</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_data</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">prokect_work_mp</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Vai" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigazione</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">server</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Codice del modulo</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, manfredi_piraino.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>